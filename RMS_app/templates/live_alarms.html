{% extends "base.html" %}
{% block div_class %}no-sidebar{% endblock %}
{% block body %}
<style>
  :root {
    --background-light: #eef3f7;
    --background-dark: linear-gradient(180deg, #141f34 0%, #101c2c 100%);
    --card-light: #fff;
    --card-dark: #141f34;
    --card-text-light: #233344;
    --card-text-dark: #d5d9e4;
    --card-border-light: #e4e8ef;
    --card-border-dark: #364665;
    --sidebar-width: 270px;
    --filter-bg-light: #fff;
    --filter-bg-dark: #1e2a4a;
    --filter-text-light: #233344;
    --filter-text-dark: #d5d9e4;
    --box-shadow-light: 0 2px 8px rgba(22,36,59,0.03);
    --box-shadow-dark: 0 2px 8px rgba(10,24,48,0.12);
  }
  div.no-sidebar .sidebar {
    display: none !important;
  }
  div.no-sidebar .main-content {
    margin-left: 0 !important;
  }
  .main-content {
    transition: margin-left 0.3s, width 0.3s;
  }
  body {
    transition: background 0.2s;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
  }
  body.dark-mode {
    background: var(--background-dark);
    color: var(--card-text-dark);
  }
  a{
    display: inline-flex;
    align-items: center;
    background-color: transparent;
    color: #141f34;
    margin-bottom: 1rem;
    border: none;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 6px;
    text-decoration: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .dark-mode a {
    color: #fff;
  }
  .alarm-layout {
    display: flex;
    min-height: calc(100vh - 56px);
  }
  .alarm-sidebar {
    width: var(--sidebar-width);
    min-width: var(--sidebar-width);
    background: var(--card-light);
    border-right: 1px solid var(--card-border-light);
    padding: 2rem 1.25rem 2rem 1.5rem;
    color: var(--card-text-light);
    transition: background 0.2s, color 0.2s;
  }
  body.dark-mode .alarm-sidebar {
    background: transparent;
    color: var(--card-text-dark);
    border-right: 1px solid var(--card-border-dark);
    box-shadow: 2px 0 8px rgba(10,24,48,0.18);
  }
  .sidebar-title {
    font-size: 1.17rem;
    font-weight: 700;
    margin-bottom: 1.4rem;
  }
  .kpi-entry {
    font-size: 1.09rem;
    margin-bottom: 1.2rem;
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: background-color 0.2s ease;
  }
  .kpi-entry:hover {
    background-color: rgba(0, 123, 255, 0.1);
  }
  .kpi-entry.active {
    background-color: rgba(0, 123, 255, 0.2);
  }
  .kpi-label {
    font-weight: 500;
    margin-right: 0.6em;
  }
  .kpi-value {
    font-weight: 600;
    font-size: 1.17rem;
    margin-left: auto;
  }
  .kpi-dot {
    width: 17px; height: 17px;
    border-radius: 50%;
    margin-right: 0.47em;
    display: inline-block;
  }
  .dot-critical { background: #ed4040; }
  .dot-major   { background: #f9a120; }
  .dot-minor   { background: #ffd600; }
  .dot-total   { background: #5e7bfd; }

  .main-content {
    flex: 1 1 0;
    padding: 2.2rem 2.8rem;
    overflow-x: auto;
    background: transparent;
    transition: background 0.2s;
  }
  .alarm-table {
    width: 100%;
    background: var(--card-light);
    border-collapse: separate;
    border-spacing: 0;
    border: 1px solid var(--card-border-light);
    border-radius: 12px;
    box-shadow: var(--box-shadow-light);
  }
  body.dark-mode .alarm-table {
    background: var(--card-dark);
    border: 1px solid var(--card-border-dark);
    box-shadow: var(--box-shadow-dark);
    color: var(--card-text-dark);
  }
  .alarm-table th, .alarm-table td {
    padding: 12px 16px;
    vertical-align: middle;
    border-bottom: 1px solid var(--card-border-light);
  }
  body.dark-mode .alarm-table th, body.dark-mode .alarm-table td {
    border-bottom: 1px solid var(--card-border-dark);
  }
  .alarm-table thead th {
    font-weight: 600;
    text-align: left;
  }
  .alarm-table tbody tr:last-child td {
    border-bottom: none;
  }
  .alarm-table .dot-critical { background: #ed4040; }
  .alarm-table .dot-major { background: #f9a120; }
  .alarm-table .dot-minor { background: #ffd600; }
  .alarm-table .severity-text { font-weight: 500; }
</style>

<div class="alarm-layout">
  <aside class="alarm-sidebar">    
    <div class="sidebar-title">
      Live Alarm Summary
    </div>
    <div class="kpi-entry" data-severity="all">
      <span class="kpi-dot dot-total"></span>
      <span class="kpi-label">Active Alarms</span>
      <span class="kpi-value" id="activeAlarmsCount">0</span>
    </div>
    <div class="kpi-entry" data-severity="Critical">
      <span class="kpi-dot dot-critical"></span>
      <span class="kpi-label">Critical Alarms</span>
      <span class="kpi-value" id="criticalAlarmsCount">0</span>
    </div>
    <div class="kpi-entry" data-severity="Major">
      <span class="kpi-dot dot-major"></span>
      <span class="kpi-label">Major Alarms</span>
      <span class="kpi-value" id="majorAlarmsCount">0</span>
    </div>
    <div class="kpi-entry" data-severity="Minor">
      <span class="kpi-dot dot-minor"></span>
      <span class="kpi-label">Minor Alarms</span>
      <span class="kpi-value" id="minorAlarmsCount">0</span>
    </div>
  </aside>

  <section class="main-content">
    <a href="/index">
      <svg xmlns="http://www.w3.org/2000/svg" 
           width="18" height="18" fill="none" stroke="currentColor"
           viewBox="0 0 18 18" style="vertical-align: middle; margin-right: 7px;">
        <path d="M12 15l-6-6 6-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Back
    </a>

    {% include "filters.html" %}
    <div style="font-size:1.08rem;font-weight:600;margin-bottom:1.1rem;">Alarm Table (Real-Time Feed)</div>
    <div class="table-responsive">
      <table class="alarm-table" id="alarmsTable">
        <thead>
          <tr>
            <th>Site ID</th>
            <th>Alarm Type</th>
            <th>Severity</th>
            <th>Timestamp</th>
            <th>date</th>
            <th>Status</th>

          </tr>
        </thead>
        <tbody id="alarmsTableBody">
          <!-- Dynamic rows inserted here -->
        </tbody>
      </table>
    </div>
  </section>
</div>

<script>
  document.body.classList.add('no-sidebar');

  document.addEventListener("DOMContentLoaded", function() {
    const kpiEntries = document.querySelectorAll(".kpi-entry");
    const tableBody = document.getElementById("alarmsTableBody");
    const activeCountElem = document.getElementById("activeAlarmsCount");
    const criticalCountElem = document.getElementById("criticalAlarmsCount");
    const majorCountElem = document.getElementById("majorAlarmsCount");
    const minorCountElem = document.getElementById("minorAlarmsCount");

    function getAlarmType(alarm) {
      if (alarm.MAINS_FAIL) return "Mains Fail";
      if (alarm.DG_Failed_to_start) return "DG Fail";
      if (alarm.DOOR_ALARM) return "Door Open";
      if (alarm.LOW_BATTERY_VOLTAGE) return "Battery Low";
      if (alarm.DG_OVERLOAD) return "Overload";
      if (alarm.HIGH_TEMPERATURE) return "Temperature High";
      if (alarm.COMMUNICATION_LOST) return "Communication Lost";
      if (alarm.POWER_FLUCTUATION) return "Power Fluctuation";
      if (alarm.SENSOR_FAILURE) return "Sensor Failure";
      // Add other alarm types as needed
      return "Unknown";
    }

    function getSeverity(alarm) {
      if (alarm.MAINS_FAIL || alarm.LOW_BATTERY_VOLTAGE || alarm.DG_Failed_to_start || alarm.COMMUNICATION_LOST) return "Critical";
      if (alarm.DG_OVERLOAD || alarm.POWER_FLUCTUATION) return "Major";
      if (alarm.DOOR_ALARM || alarm.HIGH_TEMPERATURE || alarm.SENSOR_FAILURE) return "Minor";
      return "Unknown";
    }

    function getSeverityDotClass(severity) {
      switch(severity) {
        case "Critical": return "dot-critical";
        case "Major": return "dot-major";
        case "Minor": return "dot-minor";
        default: return "";
      }
    }

    function getSeverityColor(severity) {
      switch(severity) {
        case "Critical": return "#ed4040";
        case "Major": return "#f9a120";
        case "Minor": return "#ffd600";
        default: return "#000";
      }
    }

    function formatTimestamp(timestamp) {
  if (!timestamp) return "";
  const date = new Date(timestamp);
  return date.toLocaleString([], { 
    year: 'numeric', 
    month: '2-digit', 
    day: '2-digit',
    hour: '2-digit', 
    minute: '2-digit'
  });
}


    function updateKpiCounts(data) {
      let critical = 0, major = 0, minor = 0;
      data.forEach(alarm => {
        const sev = getSeverity(alarm);
        if (sev === "Critical") critical++;
        else if (sev === "Major") major++;
        else if (sev === "Minor") minor++;
      });
      activeCountElem.textContent = data.length;
      criticalCountElem.textContent = critical;
      majorCountElem.textContent = major;
      minorCountElem.textContent = minor;
    }

    function renderTable(data) {
      tableBody.innerHTML = "";
      data.forEach(alarm => {
        const severity = getSeverity(alarm);
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${alarm.site_id || ''}</td>
          <td>${getAlarmType(alarm)}</td>
          <td>
            <span class="kpi-dot ${getSeverityDotClass(severity)}"></span>
            <span class="severity-text" style="color:${getSeverityColor(severity)};">${severity}</span>
          </td>
          <td>${formatTimestamp(alarm.created_dt)}</td>
          <td>${alarm.status || "Open"}</td>
        `;
        tableBody.appendChild(row);
      });
      setupKpiFilter();
    }

    function setupKpiFilter() {
      const rows = document.querySelectorAll("#alarmsTableBody tr");
      kpiEntries.forEach(entry => {
        entry.addEventListener("click", () => {
          const severity = entry.getAttribute("data-severity");
          rows.forEach(row => {
            const cell = row.querySelector("td:nth-child(3) .severity-text");
            const rowSeverity = cell ? cell.textContent.trim() : "";
            if (severity === "all" || rowSeverity === severity) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
          kpiEntries.forEach(e => e.classList.remove("active"));
          entry.classList.add("active");
        });
      });
      // Default to show all on load
      document.querySelector('.kpi-entry[data-severity="all"]').click();
    }

    // Fetch alarm data from REST API and render
    fetch('/api/alarms/')
      .then(response => response.json())
      .then(data => {
         const count = data.length;   // ✅ total records
         console.log("Total alarms:", count);
        updateKpiCounts(data);
        renderTable(data);
      })
      .catch(error => {
        console.error("Error loading alarm data:", error);
      });
  });
</script>

{% endblock body %}
