<style>
  :root {
    --background-light: #f6f7fb;
    --background-dark: linear-gradient(180deg, #141f34 0%, #101c2c 100%);
    --card-light: #fff;
    --card-dark: #141f34;
    --card-text-light: #233344;
    --card-text-dark: #d5d9e4;
    --card-border-light: #e4e8ef;
    --card-border-dark: #364665;
    --box-shadow-light: 0 2px 8px rgba(22, 36, 59, 0.03);
    --box-shadow-dark: 0 2px 8px rgba(10, 24, 48, 0.12);
    --filter-bg-light: #fff;
    --filter-bg-dark: #1e2a4a;
    --filter-text-light: #233344;
    --filter-text-dark: #d5d9e4;
  }
  body {
    background: var(--background-light);
    padding-top: 56px;
    transition: background 0.3s;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
      sans-serif;
  }
  body.dark-mode {
    background: var(--background-dark);
    color: var(--card-text-dark);
  }
  .filter-group.alarm-type,
  .filter-group.site-type,
  .filter-group.global-no,
  .filter-group.site-name,
  .filter-group.export,
  .filter-group.imei-no,
  .filter-group.enter_days,
  .filter-group.pdf,
  .filter-group.date-range {
    display: none !important;
  }

  main.dashboard-content {
    transition: margin-left 0.3s;
    background: var(--background-light);
  }
  body.dark-mode main.dashboard-content {
    background: var(--card-dark);
    color: var(--card-text-dark);
  }
  .sidebar:hover ~ main.dashboard-content {
    margin-left: 188px;
    width: calc(100vw - 260px);
  }

  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: flex-start;
    background: var(--filter-bg-light);
    border-radius: 12px;
    padding: 16px 24px 64px 24px;
    gap: 24px;
    box-shadow: var(--box-shadow-light);
    border: 1px solid #2189e5ff;
    margin-bottom: 24px;
    position: relative;
    min-height: 130px;
    transition: background 0.3s, color 0.3s, border-color 0.3s;
  }
  body.dark-mode .filter-bar {
    background: var(--filter-bg-dark);
    border-color: #2189e5ff;
    box-shadow: var(--box-shadow-dark);
    color: var(--filter-text-dark);
  }

  .button-group {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 16px;
  }
  .btn-search,
  .btn-reset {
    margin: 0;
    cursor: pointer;
    border: none;
    font-weight: 600;
    font-size: 1.05rem;
    border-radius: 8px;
    box-shadow: 0 4px 18px rgba(22, 36, 59, 0.12),
      0 2px 6px rgba(22, 36, 59, 0.08);
    background: inherit;
    position: relative;
    transition: transform 0.18s cubic-bezier(0.36, 1.43, 0.44, 1.01),
      box-shadow 0.18s cubic-bezier(0.36, 1.43, 0.44, 1.01);
    background-image: linear-gradient(
      120deg,
      rgba(0, 64, 255, 0.4) 0%,
      rgba(0, 208, 255, 0.2) 94%
    );
  }
  .btn-search:active,
  .btn-reset:active {
    transform: translateY(2px) scale(0.98);
    box-shadow: 0 2px 7px rgba(22, 36, 59, 0.09),
      0 1px 4px rgba(22, 36, 59, 0.08);
  }
  .btn-search:hover,
  .btn-reset:hover {
    box-shadow: 0 6px 24px rgba(160, 160, 160, 0.18),
      0 3px 8px rgba(204, 204, 204, 0.1);
    filter: brightness(1.06);
    outline: none;
  }
  .btn-search:focus,
  .btn-reset:focus {
    box-shadow: 0 0 0 2px #8b5cf6, 0 4px 18px rgba(22, 36, 59, 0.12);
  }

  .filter-group {
    display: flex;
    flex-direction: row;
    max-width: 180px;
    margin-right: 20px;
    min-width: 180px;
    flex-grow: 1;
  }
  .filter-label {
    display: flex;
    align-items: center;
    white-space: nowrap;
    font-weight: 600;
    font-size: 1rem;
    margin-right: 8px;
    color: inherit;
  }

  .filter-input {
    flex: 1;
    border-radius: 8px;
    border: 1px solid var(--card-border-light);
    padding: 3px 5px;
    font-size: 1rem;
    min-width: 130px;
    color: var(--filter-text-light);
    background: var(--card-light);
    transition: background 0.3s, color 0.3s, border-color 0.3s;
  }
  body.dark-mode .filter-input {
    background: var(--card-dark);
    border-color: var(--card-border-dark);
    color: var(--filter-text-dark);
  }
  .filter-input:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 2px #8b5cf6;
  }

  /* Custom combobox input replacing .custom-select */
  .custom-select-wrapper {
    position: relative; /* Added to position dropdown relative */
    width: 100%;  /* Make wrapper width 100% of filter-group */
  }
  .custom-combobox {
    width: 100%;
    box-sizing: border-box;
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid var(--card-border-light);
    font-size: 1rem;
    color: var(--filter-text-light);
    background: var(--card-light);
    cursor: text;
  }
  body.dark-mode .custom-combobox {
    background: var(--card-dark);
    border-color: var(--card-border-dark);
    color: var(--card-text-dark);
  }
  .custom-combobox:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 2px #8b5cf6;
  }

  /* Dropdown options below input */
  .custom-options {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    width: 100%; /* Make dropdown width same as wrapper */
    max-height: 200px;
    overflow-y: auto;
    background: var(--card-light);
    border: 1px solid #2189e5ff;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 2px 8px rgba(22, 36, 59, 0.12);
    z-index: 1000;
  }
  body.dark-mode .custom-options {
    background: var(--card-dark);
    border-color: #2189e5ff;
    box-shadow: 0 2px 8px rgba(10, 24, 48, 0.12);
  }
  .custom-option {
    padding: 6px 10px;
    cursor: pointer;
    white-space: nowrap;
  }
  .custom-option:hover,
  .custom-option[aria-selected="true"] {
    background: #0b63ff22;
  }

  /* Scrollbar styling */
  .custom-options::-webkit-scrollbar {
    width: 8px;
  }
  .custom-options::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 8px;
  }
  .custom-options::-webkit-scrollbar-thumb {
    background-color: #2189e5ff;
    border-radius: 8px;
    border: 2px solid transparent;
    background-clip: content-box;
    transition: background-color 0.3s;
  }
  .custom-options::-webkit-scrollbar-thumb:hover {
    background-color: #005bb5ff;
  }
  .custom-options {
    scrollbar-width: thin;
    scrollbar-color: #2189e5ff transparent;
  }
  .custom-options:hover {
    scrollbar-color: #005bb5ff transparent;
  }

  @media (max-width: 900px) {
    .filter-bar {
      flex-direction: column;
      gap: 16px;
      min-height: auto;
      padding-bottom: 80px;
    }
    main.dashboard-content {
      padding: 12px;
      width: 100vw;
      margin-left: 0;
    }
    body.dark-mode main.dashboard-content {
      width: 100vw;
    }
  }
  @media (max-width: 600px) {
    .button-group {
      flex-direction: column;
      bottom: 16px;
      gap: 12px;
      width: 100%;
      left: 0;
      transform: none;
      justify-content: center;
      align-items: center;
    }
  }
  .date-time {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 16px;
    flex-wrap: nowrap;
  }
  .date-time label {
    margin-bottom: 0;
    white-space: nowrap;
  }
  .date-time input {
    min-width: 180px;
  }
</style>

<main class="dashboard-content">
  <div class="filter-bar" role="region" aria-label="Filter Alarms">

    <div class="filter-group">
      <label class="filter-label" for="filter-circle-input">Circle:</label>
      <div class="custom-select-wrapper" id="filter-circle-wrapper" role="combobox" aria-haspopup="listbox" aria-expanded="false" aria-owns="filter-circle-list">
        <input type="text" id="filter-circle-input" class="custom-combobox" aria-autocomplete="list" aria-controls="filter-circle-list" aria-activedescendant="" autocomplete="off" placeholder="All" />
        <div class="custom-options" id="filter-circle-list" role="listbox" tabindex="-1">
          <div class="custom-option" role="option" data-value="All" id="filter-circle-option-all">All</div>
          <div class="custom-option" role="option" data-value="Mumbai" id="filter-circle-option-mumbai">Mumbai</div>
          <div class="custom-option" role="option" data-value="South" id="filter-circle-option-south">South</div>
          <div class="custom-option" role="option" data-value="North" id="filter-circle-option-north">North</div>
        </div>
      </div>
      <input type="hidden" name="circle" id="filter-circle" />
    </div>

    <div class="filter-group">
      <label class="filter-label" for="filter-cluster-input">Cluster:</label>
      <div class="custom-select-wrapper" id="filter-cluster-wrapper" role="combobox" aria-haspopup="listbox" aria-expanded="false" aria-owns="filter-cluster-list">
        <input type="text" id="filter-cluster-input" class="custom-combobox" aria-autocomplete="list" aria-controls="filter-cluster-list" aria-activedescendant="" autocomplete="off" placeholder="All" />
        <div class="custom-options" id="filter-cluster-list" role="listbox" tabindex="-1">
          <div class="custom-option" role="option" data-value="" id="filter-cluster-option-all">All</div>
          {% for c in clusters %}
          <div class="custom-option" role="option" data-value="{{ c.cluster }}" id="filter-cluster-option-{{ c.cluster|slugify }}">{{ c.cluster }}</div>
          {% endfor %}
        </div>
      </div>
      <input type="hidden" name="cluster" id="cluster" />
    </div>

    <div class="filter-group">
      <label class="filter-label" for="filter-site-type-input">Site Type:</label>
      <div class="custom-select-wrapper" id="filter-site-type-wrapper" role="combobox" aria-haspopup="listbox" aria-expanded="false" aria-owns="filter-site-type-list">
        <input type="text" id="filter-site-type-input" class="custom-combobox" aria-autocomplete="list" aria-controls="filter-site-type-list" aria-activedescendant="" autocomplete="off" placeholder="All" />
        <div class="custom-options" id="filter-site-type-list" role="listbox" tabindex="-1">
          <div class="custom-option" role="option" data-value="All" id="filter-site-type-option-all">All</div>
          <div class="custom-option" role="option" data-value="Type A" id="filter-site-type-option-a">Type A</div>
          <div class="custom-option" role="option" data-value="Type B" id="filter-site-type-option-b">Type B</div>
          <div class="custom-option" role="option" data-value="Type C" id="filter-site-type-option-c">Type C</div>
        </div>
      </div>
      <input type="hidden" name="site_type" id="filter-site-type" />
    </div>

    <div class="filter-group {% if hide_alarm_type %}alarm-type{% endif %}">
      <label class="filter-label" for="filter-alarm-type-input">Alarm Type:</label>
      <div class="custom-select-wrapper" id="filter-alarm-type-wrapper" role="combobox" aria-haspopup="listbox" aria-expanded="false" aria-owns="filter-alarm-type-list">
        <input type="text" id="filter-alarm-type-input" class="custom-combobox" aria-autocomplete="list" aria-controls="filter-alarm-type-list" aria-activedescendant="" autocomplete="off" placeholder="All" />
        <div class="custom-options" id="filter-alarm-type-list" role="listbox" tabindex="-1">
          <div class="custom-option" role="option" data-value="All" id="filter-alarm-type-option-all">All</div>
          <div class="custom-option" role="option" data-value="Mains Fail" id="filter-alarm-type-option-mains">Mains Fail</div>
          <div class="custom-option" role="option" data-value="DG Fail" id="filter-alarm-type-option-dg">DG Fail</div>
          <div class="custom-option" role="option" data-value="Door Open" id="filter-alarm-type-option-door">Door Open</div>
        </div>
      </div>
      <input type="hidden" name="alarm_type" id="filter-alarm-type" />
    </div>

    <div class="filter-group {% if hide_site_name %}site-name{% endif %}">
      <label for="filter-site-name" class="filter-label">Site Name:</label>
      <input
        type="text"
        placeholder="Enter Site Name"
        id="filter-site-name"
        class="filter-input"
        name="site_name"
      />
    </div>

    <div class="filter-group {% if hide_global_no %}global-no{% endif %}">
      <label for="filter-global-no" class="filter-label">Global No:</label>
      <input
        type="text"
        placeholder="Enter Global No"
        id="filter-global-no"
        class="filter-input"
        aria-controls="alarmsTable"
      />
    </div>

    <div class="filter-group">
      <label for="filter-site-id" class="filter-label">Site ID:</label>
      <input
        id="filter-site-id"
        class="filter-input"
        type="text"
        aria-controls="alarmsTable"
        placeholder="Enter Site ID..."
      />
    </div>

    <div class="filter-group {% if hide_enter_days %}enter_days{% endif %}">
      <label for="filter-enter-days" class="filter-label">Enter Days:</label>
      <input
        type="text"
        placeholder="Enter Days"
        id="filter-enter-days"
        class="filter-input"
        aria-controls="alarmsTable"
      />
    </div>

    <div class="filter-group {% if hide_imei_no %}imei-no{% endif %}">
      <label for="filter-imei-no" class="filter-label">IMEI No:</label>
      <input
        id="filter-imei-no"
        class="filter-input"
        type="text"
        aria-controls="alarmsTable"
        placeholder="Enter IMEI No..."
      />
    </div>

    <div class="filter-group {% if hide_date %}date-range{% endif %}">
      <label for="filter-from" class="filter-label">Date Range:</label>
      <div class="date-time">
        <label for="filter-from" class="filter-label">From:</label>
        <input type="datetime-local" id="filter-from" class="filter-input" name="from_date" disabled />
        <label for="filter-to" class="filter-label">To:</label>
        <input type="datetime-local" id="filter-to" class="filter-input" name="to_date" disabled />
      </div>
    </div>

    <div class="button-group" role="group" aria-label="Search and reset filter actions">
      <button type="submit" class="filter-input btn-search">Search</button>
      <button type="reset" class="filter-input btn-reset">Reset</button>
    </div>
  </div>
</main>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const customSelectWraps = document.querySelectorAll(".custom-select-wrapper");

    customSelectWraps.forEach(wrapper => {
      const input = wrapper.querySelector(".custom-combobox");
      const optionsList = wrapper.querySelector(".custom-options");
      const options = optionsList.querySelectorAll(".custom-option");
      const hiddenInput = wrapper.nextElementSibling;

      // Filter dropdown options based on input value
      function filterOptions() {
        const val = input.value.toLowerCase();
        let visibleCount = 0;
        options.forEach(option => {
          const text = option.textContent.toLowerCase();
          if (text.includes(val)) {
            option.style.display = "";
            visibleCount++;
          } else {
            option.style.display = "none";
          }
        });
        optionsList.style.display = visibleCount > 0 ? "block" : "none";
        wrapper.setAttribute("aria-expanded", visibleCount > 0);
      }

      // Select an option
      function selectOption(option) {
        input.value = option.textContent;
        hiddenInput.value = option.dataset.value;
        options.forEach(o => o.setAttribute("aria-selected", "false"));
        option.setAttribute("aria-selected", "true");
        optionsList.style.display = "none";
        wrapper.setAttribute("aria-expanded", "false");
        input.focus();

        // Save to sessionStorage
        if (hiddenInput.id) {
          sessionStorage.setItem(hiddenInput.id, hiddenInput.value);
        }
      }

      // Show options when input focused
      input.addEventListener("focus", () => {
        filterOptions();
      });

      // Filter on input
      input.addEventListener("input", () => {
        filterOptions();
      });

      // Hide dropdown on blur, with timeout to allow click
      input.addEventListener("blur", () => {
        setTimeout(() => {
          optionsList.style.display = "none";
          wrapper.setAttribute("aria-expanded", "false");
        }, 200);
      });

      // Click on option
      options.forEach(option => {
        option.addEventListener("mousedown", (e) => {
          e.preventDefault(); // prevent blur
          selectOption(option);
        });
      });

      // Keyboard navigation
      input.addEventListener("keydown", (e) => {
        const visibleOptions = Array.from(options).filter(o => o.style.display !== "none");
        let index = visibleOptions.findIndex(o => o.getAttribute("aria-selected") === "true");

        switch(e.key) {
          case "ArrowDown":
            e.preventDefault();
            if (index < visibleOptions.length - 1) index++;
            else index = 0;
            visibleOptions.forEach(o => o.setAttribute("aria-selected", "false"));
            visibleOptions[index].setAttribute("aria-selected", "true");
            input.setAttribute("aria-activedescendant", visibleOptions[index].id);
            visibleOptions[index].scrollIntoView({block: "nearest"});
            break;
          case "ArrowUp":
            e.preventDefault();
            if (index > 0) index--;
            else index = visibleOptions.length - 1;
            visibleOptions.forEach(o => o.setAttribute("aria-selected", "false"));
            visibleOptions[index].setAttribute("aria-selected", "true");
            input.setAttribute("aria-activedescendant", visibleOptions[index].id);
            visibleOptions[index].scrollIntoView({block: "nearest"});
            break;
          case "Enter":
            e.preventDefault();
            if (index >= 0) selectOption(visibleOptions[index]);
            break;
          case "Escape":
            optionsList.style.display = "none";
            wrapper.setAttribute("aria-expanded", "false");
            break;
        }
      });

      // Restore from sessionStorage on load
      if (hiddenInput && hiddenInput.id) {
        const val = sessionStorage.getItem(hiddenInput.id);
        if (val !== null && val !== "") {
          const matchOption = Array.from(options).find(o => o.dataset.value === val);
          if (matchOption) {
            input.value = matchOption.textContent;
            hiddenInput.value = val;
            options.forEach(o => o.setAttribute("aria-selected", "false"));
            matchOption.setAttribute("aria-selected", "true");
          }
        }
      }
    });

    // Save text inputs & hidden inputs on change/input
    const filterIds = [
      "filter-circle", "cluster", "filter-site-type", "filter-alarm-type",
      "filter-site-name", "filter-global-no", "filter-site-id", "filter-enter-days",
      "filter-imei-no", "filter-from", "filter-to"
    ];

    filterIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("change", () => {
          sessionStorage.setItem(id, el.value);
        });
        el.addEventListener("input", () => {
          sessionStorage.setItem(id, el.value);
        });
      }
    });

    // Restore text inputs & hidden inputs from sessionStorage on load
    filterIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        const savedValue = sessionStorage.getItem(id);
        if (savedValue !== null) {
          el.value = savedValue;
        }
      }
    });

    // Reset button clears storage and resets inputs
    const resetBtn = document.querySelector(".btn-reset");
    if (resetBtn) {
      resetBtn.addEventListener("click", (e) => {
        e.preventDefault();
        filterIds.forEach(id => sessionStorage.removeItem(id));
        document.querySelectorAll(".custom-select-wrapper").forEach(wrapper => {
          const input = wrapper.querySelector(".custom-combobox");
          const options = wrapper.querySelectorAll(".custom-option");
          const hiddenInput = wrapper.nextElementSibling;

          options.forEach(o => o.setAttribute("aria-selected", "false"));
          if (options.length > 0) {
            input.value = options[0].textContent;
            hiddenInput.value = options[0].dataset.value;
            options[0].setAttribute("aria-selected", "true");
          } else {
            input.value = "";
            if (hiddenInput) hiddenInput.value = "";
          }
        });
        filterIds.forEach(id => {
          const el = document.getElementById(id);
          if (el && (el.tagName !== "INPUT" || el.type !== "hidden")) el.value = "";
        });
        console.log("Filters reset and sessionStorage cleared");
      });
    }
  });
</script>
